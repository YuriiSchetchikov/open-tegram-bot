import telebot
import datetime
import configurate
from pyowm import OWM
from pyowm.utils.config import get_default_config
from pyowm.utils import timestamps


owm = OWM('–≤–∞—à API –∫–ª—é—á')
mgr = owm.weather_manager()
config_dict = get_default_config()
config_dict['language'] = 'ru'
owm = OWM('–≤–∞—à API –∫–ª—é—á', config_dict)
client = telebot.TeleBot(configurate.config['token'])


@client.message_handler(commands=['start'])
def start_bot(message):
    date = datetime.datetime.now()
    hr = date.strftime("%H")
    if hr <= str(4) or hr >= str(20):
        sti = open('img/night.tgs', 'rb')
        client.send_animation(message.chat.id, sti)
    else:
        sti1 = open('img/hello.tgs', 'rb')
        client.send_animation(message.chat.id, sti1)

    start = f"<b>–î–æ–±—Ä–æ –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å {message.from_user.first_name}!</b>\n –î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É –≤ —Ç–æ–º –∏–ª–∏ –∏–Ω–æ–º –≥–æ—Ä–æ–¥–µ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ:"
    client.send_message(message.chat.id, start, parse_mode='html')


@client.message_handler(content_types=['text'])
def send_answer(message):
    try:
        date = datetime.datetime.now()
        hr = date.strftime("%H")
        observation = mgr.weather_at_place(message.text)
        w = observation.weather
        w.wind()
        humi = w.humidity
        temp = w.temperature('celsius')['temp']

        answer = "–í –≥–æ—Ä–æ–¥–µ " + message.text + " —Å–µ–π—á–∞—Å " + w.detailed_status + "\n"
        answer += "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–µ–π—á–∞—Å " + str(temp) + "¬∞C." + "\n"
        answer += "–î–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç" + str(humi) + "–º3" + "\n\n"

        if temp < -5:
            answer += "–ù–∞ —É–ª–∏—Ü–µ —Å–∏–ª—å–Ω—ã–π –º–æ—Ä–æ–∑, –æ–¥–µ–≤–∞–π—Å—è —Ç–µ–ø–ª–æ ü•∂"
        elif temp < 0:
            answer += "–ù–∞ —É–ª–∏—Ü–µ –º–æ—Ä–æ–∑, –æ–¥–µ–≤–∞–π—Å—è —Ç–µ–ø–ª–æ ü•∂."
        elif temp <= 10:
            answer += "–ö–∞–∫-—Ç–æ –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ, –æ–¥–µ–≤–∞–π—Å—è –ø–æ—Ç–µ–ø–ª–µ–µ üôÇ."
        elif temp <= 17:
            answer += "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø—Ä–∏–µ–º–ª–∏–º–∞—è, –Ω–æ –æ–¥–µ—Ç—å—Å—è —Å—Ç–æ–∏—Ç üòä."
        elif temp >= 30:
            answer += "–ù—É –∏ –∂–∞—Ä–∞ üò±"
            sti3 = open('img/hot.tgs', 'rb')
            client.send_animation(message.chat.id, sti3)
        else:
            answer += "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ—Ç–ª–∏—á–Ω–∞—è –æ–¥–µ–≤–∞–π—Å—è –≤–æ —á—Ç–æ —Ö–æ—á–µ—à—å üòâ."
        client.send_message(message.chat.id, answer)
    except Exception as e:
        print(e)
        sti4 = open('img/error.tgs', 'rb')
        client.send_animation(message.chat.id, sti4)
        client.send_message(
            message.chat.id, '–ì–æ—Ä–æ–¥ –≤–≤–µ–¥—ë–Ω –Ω–µ–≤–µ—Ä–Ω–æ ü§®\n–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑üòÉ')


client.polling(none_stop=True)
